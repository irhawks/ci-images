image: $CI_DOCKER_REMOTE_NAME/irhawks/docker:stable

services:
  - $CI_DOCKER_REMOTE_NAME/irhawks/docker:dind

variables:
  DOCKER_HOST: tcp://localhost:2375/
  DOCKER_DRIVER: overlay2

before_script:
  - docker info
  - docker login --username $CI_DOCKER_UPLOAD_USER --password $CI_DOCKER_UPLOAD_PASS $CI_DOCKER_UPLOAD_NAME

stages:
  - build
  - deploy

build-maven:
  stage: build
  only:
    changes:
      - maven/*
  script:
  - cd maven
  - docker build -t $CI_DOCKER_UPLOAD_NAME/irhawks/maven:default .

deploy-maven:
  stage: deploy
  only:
    changes:
      - maven/*
  dependencies:
  - build-maven
  script:
  - cd maven
  - docker push $CI_DOCKER_UPLOAD_NAME/irhawks/maven:default
  when: always

build-r-testthat:
  stage: build
  only:
    changes:
      - r/*
  script:
  - cd r/testthat
  - docker build -t ${CI_DOCKER_UPLOAD_NAME}/irhawks/rlang-ci:3.4.1 .
  
deploy-r-testthat:
  stage: deploy
  only:
    changes:
      - r/*
  dependencies:
  - build-r-testthat
  script:
  - cd r/testthat
  - docker push -t ${CI_DOCKER_UPLOAD_NAME}/irhawks/rlang-ci:3.4.1
  when: always
